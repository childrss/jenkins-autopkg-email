// this is groovy, a derivitive of Java
// Requires the following Jenkins plug-ins:
//          Email-ext
//          EnvInject

// Load up the first 1000 lines of the log file into a variable
def log = build.getLog(1000)

// Let's setup a boolean of the result of searching for the string that appears
// in the log file when a job successfully completes but no work occurred.

def NothingDone = log =~ /Nothing downloaded, packaged or imported/
logger.println("** NothingDone is " + NothingDone)

def Error = log =~ /Error/
logger.println("** Error is " + Error)

def error = log =~ /error/
logger.println("** error is " + error)

// New items were imported into the munki repo
def NewItemsImported = log =~ /new items were imported/
logger.println("** NewItemsImported is " + NewItemsImported)

// New items were downloaded to the AutoPkg Cache directory
def NewItemsDownloaded = log =~ /new items were downloaded/
logger.println("** NewItemsDownloaded is " + NewItemsDownloaded)

/* The below code is for AutoPkg FAQ #1:
 *
 * Every time I run a recipe it downloads something even if it didn't change. Why?
 *      https://github.com/autopkg/autopkg/wiki/FAQ
 *
 * the IS_TROUBLEMAKER is a per-job environmental variable set using the 
 * Jenkins EnvInject Plugin -- https://wiki.jenkins-ci.org/display/JENKINS/EnvInject+Plugin
 *
 * below is the elvis/ternary operator that does the following:
 * if IS_TROUBLEMAKER is set from the Jenkins job configuration, take that value
 * (it should be true).  If it's not set/doesn't exist, set it to false
 * because we have a lot of existing jobs and only set the IS_TROUBLEMAKER on jobs that
 * ARE troublemakers!
 */
 
def is_troublemaker = System.getenv("IS_TROUBLEMAKER") ?: false
logger.println("** is_troublemaker is " + is_troublemaker)

/* And now let's test against that boolean and kill the e-mail (cancelEmail = true) if it found the
 * -Nothing downloaded, packaged or imported- string  AND it hasn't found a string with Error or error
 */
 
if (NothingDone && !Error && !error) {

	// AutoPkg neither downloaded to the AutoPkg Cache nor imported anything to the munki repo, 
	// so no e-mail this is the case 99% of the time
	logger.println("=== e-mail cancelled: Job completed without errors but nothing was done (nothing downloaded or imported)")
	cancel=true
	
} else if (NewItemsDownloaded && !is_troublemaker) {

	// logger.println("** AutoPkg downloaded, but not imported to Munki as " + $JOB_NAME + " is a known troublemaker.")
	logger.println("=== e-mail cancelled: KNOWN TROUBLEMAKER: AutoPkg downloaded sucessufully (but no import as this version was already in the munki repo")
	logger.println("=== See AutoPkg FAQ, item #1 at https://github.com/autopkg/autopkg/wiki/FAQ")
	cancel=true

} else if (NewItemsImported) {
	
	// New items were imported into the Munki Repo, send the email.
	logger.println("=*=*=*=*=*=*=*=*=*=*=*=* New Item in Munki Repo, E-mail Sent !!!! =*=*=*=*=*=*=*=*=*=*=*=*")
	cancel=false

} else { 
    // Send the email, something's run amok
    cancel=false
	logger.println('@#$%&!@#$%&!@#$%&!@#$%&!      Ruh Roh!  Something went wrong -- E-mail Sent !!!!! @#$%&!@#$%&!@#$%&!@#$%&!')
}

// logger.println("** End of Presend Script and it is " + IS_TROUBLEMAKER + " that " + JOB_NAME + " is a known troublemaker.")
// logger.println("** cancel = " + cancel)
// logger.println("** \n\nlogfile begin ..........\n" + log + "\n\n..........\nlog file end")
